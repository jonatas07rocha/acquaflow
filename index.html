<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AquaFlow - Seu Aplicativo de Hidrata√ß√£o</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Estilos globais para a transi√ß√£o de elementos com o Tailwind */
    body {
      transition: all 0.3s ease-in-out;
    }
    /* Classe para anima√ß√£o de rota√ß√£o */
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { Home, BarChart3, Settings, Save, RefreshCcw, X, Thermometer, Ruler } = lucide;

    // Hook customizado para persistir o estado no localStorage
    const useLocalStorage = (key, initialValue) => {
      const [storedValue, setStoredValue] = useState(() => {
        try {
          const item = window.localStorage.getItem(key);
          return item ? JSON.parse(item) : initialValue;
        } catch (error) {
          console.error(error);
          return initialValue;
        }
      });

      useEffect(() => {
        try {
          window.localStorage.setItem(key, JSON.stringify(storedValue));
        } catch (error) {
          console.error(error);
        }
      }, [key, storedValue]);

      return [storedValue, setStoredValue];
    };

    // Componente principal da aplica√ß√£o
    const App = () => {
      const [currentWater, setCurrentWater] = useLocalStorage('currentWater', 0);
      const [goalWater, setGoalWater] = useLocalStorage('goalWater', 2500);
      const [waterHistory, setWaterHistory] = useLocalStorage('waterHistory', [0, 0, 0, 0, 0, 0, 0]);
      const [lastUpdateDate, setLastUpdateDate] = useLocalStorage('lastUpdateDate', new Date().toDateString());

      const [currentPage, setCurrentPage] = useState('home');
      const [isAddModalOpen, setIsAddModalOpen] = useState(false);
      const [feedbackModal, setFeedbackModal] = useState({ isOpen: false, message: '', isError: false });
      const motivationalMilestoneRef = useRef(0);

      const [currentTemperature, setCurrentTemperature] = useState(null);
      const [recommendedGoalByTemperature, setRecommendedGoalByTemperature] = useState(null);
      const [isLoadingTemperature, setIsLoadingTemperature] = useState(false);

      const [userWeight, setUserWeight] = useLocalStorage('userWeight', 70);
      const [recommendedGoalByWeight, setRecommendedGoalByWeight] = useState(null);

      useEffect(() => {
        const today = new Date().toDateString();
        if (today !== lastUpdateDate) {
          setWaterHistory(prevHistory => [...prevHistory.slice(1), 0]);
          setCurrentWater(0);
          setLastUpdateDate(today);
          showFeedbackModal('Um novo dia come√ßou! Seu contador foi zerado.', false);
          motivationalMilestoneRef.current = 0;
        }
      }, [lastUpdateDate]);

      useEffect(() => {
        const percentage = (currentWater / goalWater) * 100;
        const currentMilestone = motivationalMilestoneRef.current;

        if (percentage >= 100 && currentMilestone < 100) {
          showFeedbackModal("Meta atingida! Parab√©ns! üèÜ");
          motivationalMilestoneRef.current = 100;
        } else if (percentage >= 75 && currentMilestone < 75) {
          showFeedbackModal("Voc√™ est√° quase l√°, continue!");
          motivationalMilestoneRef.current = 75;
        } else if (percentage >= 50 && currentMilestone < 50) {
          showFeedbackModal("Voc√™ est√° na metade! üéâ");
          motivationalMilestoneRef.current = 50;
        } else if (percentage > 0 && currentMilestone === 0) {
          showFeedbackModal("√ìtimo come√ßo de dia!");
          motivationalMilestoneRef.current = 1;
        }
      }, [currentWater, goalWater]);

      const fetchTemperatureAndRecommendGoal = async () => {
        setIsLoadingTemperature(true);
        await new Promise(resolve => setTimeout(resolve, 1000));
        const simulatedTemp = 20 + Math.floor(Math.random() * 15);
        setCurrentTemperature(simulatedTemp);

        let newRecommendedGoal = goalWater;
        if (simulatedTemp >= 30) {
          newRecommendedGoal = Math.floor(goalWater * 1.3);
        } else if (simulatedTemp >= 25) {
          newRecommendedGoal = Math.floor(goalWater * 1.1);
        } else {
          newRecommendedGoal = goalWater;
        }
        setRecommendedGoalByTemperature(newRecommendedGoal);
        setIsLoadingTemperature(false);
      };
      
      useEffect(() => {
        if(currentPage === 'settings') {
          fetchTemperatureAndRecommendGoal();
        }
      }, [currentPage]);

      useEffect(() => {
        if (userWeight > 0) {
          setRecommendedGoalByWeight(Math.floor(userWeight * 35));
        } else {
          setRecommendedGoalByWeight(null);
        }
      }, [userWeight]);

      const handleAddWater = (amount) => {
        if (isNaN(amount) || amount <= 0) return;
        const newCurrentWater = currentWater + amount;
        
        const newWaterHistory = [...waterHistory];
        newWaterHistory[newWaterHistory.length - 1] += amount;

        setCurrentWater(newCurrentWater);
        setWaterHistory(newWaterHistory);
        setIsAddModalOpen(false);
      };

      const handleApplyRecommendedGoal = (goal) => {
        if (goal) {
          setGoalWater(goal);
          showFeedbackModal(`Meta atualizada para ${goal} ml!`);
        }
      };

      const showFeedbackModal = (message, isError = false) => {
        setFeedbackModal({ isOpen: true, message, isError });
        setTimeout(() => {
          setFeedbackModal({ isOpen: false, message: '', isError: false });
        }, 3000);
      };

      const renderPage = () => {
        switch (currentPage) {
          case 'stats':
            return (
              <StatsPage
                waterHistory={waterHistory}
                goalWater={goalWater}
                onClose={() => setCurrentPage('home')}
              />
            );
          case 'settings':
            return (
              <SettingsPage
                goalWater={goalWater}
                setGoalWater={setGoalWater}
                onResetWater={() => {
                    setCurrentWater(0);
                    showFeedbackModal('Contador de √°gua zerado!');
                }}
                showFeedbackModal={showFeedbackModal}
                onClose={() => setCurrentPage('home')}
                currentTemperature={currentTemperature}
                recommendedGoalByTemperature={recommendedGoalByTemperature}
                isLoadingTemperature={isLoadingTemperature}
                onFetchTemperature={fetchTemperatureAndRecommendGoal}
                onApplyRecommendedGoal={handleApplyRecommendedGoal}
                userWeight={userWeight}
                setUserWeight={setUserWeight}
                recommendedGoalByWeight={recommendedGoalByWeight}
              />
            );
          case 'home':
          default:
            return (
              <HomePage
                currentWater={currentWater}
                goalWater={goalWater}
              />
            );
        }
      };

      return (
        <div className="font-sans bg-gradient-to-br from-cyan-400 to-blue-600 min-h-screen flex items-center justify-center p-4 text-white">
          <div className="w-full max-w-sm h-[90vh] max-h-[800px] bg-white/10 backdrop-blur-xl rounded-[40px] shadow-2xl overflow-hidden relative flex flex-col border border-white/20 p-6">
            {renderPage()}
            <BottomNav
              currentPage={currentPage}
              onNavigate={setCurrentPage}
              onOpenAddWater={() => setIsAddModalOpen(true)}
            />
          </div>

          <AddWaterModal
            isOpen={isAddModalOpen}
            onClose={() => setIsAddModalOpen(false)}
            onAddWater={handleAddWater}
          />

          <FeedbackModal
            isOpen={feedbackModal.isOpen}
            message={feedbackModal.message}
            isError={feedbackModal.isError}
          />
        </div>
      );
    };

    const Header = ({ pageTitle }) => {
      const titles = {
        home: 'AquaFlow',
        stats: 'Estat√≠sticas',
        settings: 'Configura√ß√µes'
      };
      return (
        <header className="flex justify-between items-center text-white z-10">
          <div>
            <h1 className="font-bold text-2xl capitalize">{titles[pageTitle] || 'AquaFlow'}</h1>
            <p className="text-sm opacity-80">Ol√°! Mantenha-se hidratado.</p>
          </div>
        </header>
      );
    };

    const HomePage = ({ currentWater, goalWater }) => {
      return (
        <>
          <Header pageTitle="home" />
          <main className="flex-1 flex flex-col items-center justify-center text-center -mt-16">
            <ProgressChart currentWater={currentWater} goalWater={goalWater} />
            <p className="mt-8 text-lg font-bold">Mantenha o foco na sua meta!</p>
            <p className="text-sm opacity-80 max-w-xs mt-2">A hidrata√ß√£o √© essencial para o seu bem-estar e energia.</p>
          </main>
        </>
      );
    };

    const StatsPage = ({ waterHistory, goalWater, onClose }) => {
      const chartRef = useRef(null);
      const chartInstanceRef = useRef(null);
      const daysOfWeek = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Hoje'];
      const closeButtonRef = useRef(null);

      useEffect(() => {
        if (closeButtonRef.current) {
            closeButtonRef.current.focus();
        }
      }, []);

      useEffect(() => {
        if (chartRef.current) {
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
          }
          const ctx = chartRef.current.getContext('2d');
          chartInstanceRef.current = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: daysOfWeek,
              datasets: [{
                label: 'Consumo (ml)',
                data: waterHistory,
                backgroundColor: 'rgba(255, 255, 255, 0.5)',
                borderColor: 'rgba(255, 255, 255, 0.8)',
                borderWidth: 1,
                borderRadius: 8,
              }, {
                label: 'Meta',
                data: Array(7).fill(goalWater),
                type: 'line',
                borderColor: '#ffffff',
                borderWidth: 2,
                pointRadius: 0,
                fill: false,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
              },
              scales: {
                x: {
                  grid: { display: false },
                  ticks: { color: 'white' }
                },
                y: {
                  beginAtZero: true,
                  grid: { color: 'rgba(255, 255, 255, 0.2)' },
                  ticks: { color: 'white' }
                }
              }
            }
          });
        }
        return () => {
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
          }
        };
      }, [waterHistory, goalWater]);

      return (
        <div className="absolute inset-0 w-full h-full flex flex-col items-center">
          <div className="flex justify-between items-center w-full mb-6">
            <h2 className="text-2xl font-bold">Estat√≠sticas</h2>
            <button onClick={onClose} ref={closeButtonRef} className="p-2 rounded-full hover:bg-white/20 transition-colors" aria-label="Fechar Estat√≠sticas">
              <X size={24} />
            </button>
          </div>
          <div className="w-full h-64 p-4 rounded-2xl">
            <canvas ref={chartRef}></canvas>
          </div>
          <p className="opacity-80 mt-4 text-sm">Hist√≥rico de consumo dos √∫ltimos 7 dias.</p>
        </div>
      );
    };

    const SettingsPage = ({ goalWater, setGoalWater, onResetWater, showFeedbackModal, onClose, currentTemperature, recommendedGoalByTemperature, isLoadingTemperature, onFetchTemperature, onApplyRecommendedGoal, userWeight, setUserWeight, recommendedGoalByWeight }) => {
      const [newGoal, setNewGoal] = useState(goalWater);
      const closeButtonRef = useRef(null);

      useEffect(() => {
        if (closeButtonRef.current) {
          closeButtonRef.current.focus();
        }
      }, []);

      const handleSaveGoal = () => {
        const parsedGoal = parseInt(newGoal, 10);
        if (!isNaN(parsedGoal) && parsedGoal > 0) {
          setGoalWater(parsedGoal);
          showFeedbackModal('Meta salva com sucesso!');
        } else {
          showFeedbackModal('Por favor, insira um valor v√°lido para a meta.', true);
        }
      };

      return (
        <div className="absolute inset-0 w-full h-full flex flex-col">
          <div className="flex justify-between items-center w-full mb-8">
            <h2 className="text-2xl font-bold">Configura√ß√µes</h2>
            <button onClick={onClose} ref={closeButtonRef} className="p-2 rounded-full hover:bg-white/20 transition-colors" aria-label="Fechar Configura√ß√µes">
              <X size={24} />
            </button>
          </div>

          <div className="flex flex-col gap-6 w-full">
            <div>
              <h3 className="text-lg font-bold mb-3">Ajuste da Meta Di√°ria</h3>
              <div className="flex flex-col items-start w-full">
                <label htmlFor="goal" className="text-sm opacity-80 mb-1">Meta di√°ria (ml)</label>
                <input
                  id="goal"
                  type="number"
                  value={newGoal}
                  onChange={(e) => setNewGoal(e.target.value)}
                  className="w-full bg-white/20 rounded-xl px-4 py-2 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50"
                />
              </div>
              <button
                onClick={handleSaveGoal}
                className="flex items-center justify-center gap-2 p-3 rounded-xl bg-white text-blue-500 font-bold hover:bg-gray-200 transition-colors mt-4 w-full"
                aria-label="Salvar meta"
              >
                <Save size={20} />
                <span>Salvar Meta</span>
              </button>
            </div>
            
            <div>
              <h3 className="text-lg font-bold mb-3">Meta por Peso</h3>
              <div className="flex flex-col gap-2 w-full">
                <div className="flex items-center justify-between w-full">
                  <label htmlFor="weight" className="text-sm opacity-80 mb-1 flex items-center gap-2">
                    <Ruler size={16} />
                    Peso (kg)
                  </label>
                  <input
                    id="weight"
                    type="number"
                    value={userWeight}
                    onChange={(e) => setUserWeight(parseInt(e.target.value) || 0)}
                    className="w-20 bg-white/20 rounded-xl px-4 py-2 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50 text-right"
                  />
                </div>
                {recommendedGoalByWeight && (
                  <div className="flex items-center justify-between w-full p-3 rounded-xl bg-white/20">
                    <span className="text-sm">Meta Recomendada: <span className="font-bold">{recommendedGoalByWeight} ml</span></span>
                    <button
                      onClick={() => onApplyRecommendedGoal(recommendedGoalByWeight)}
                      className="p-1 rounded-full bg-white text-blue-500 hover:bg-gray-200 transition-colors"
                      aria-label="Aplicar meta recomendada"
                    >
                      <Save size={16} />
                    </button>
                  </div>
                )}
              </div>
            </div>

            <div>
              <h3 className="text-lg font-bold mb-3">Meta por Temperatura</h3>
              <div className="flex flex-col gap-2 w-full">
                <p className="flex items-center gap-2 text-sm opacity-80">
                  <Thermometer size={16} />
                  {currentTemperature ? `Temperatura atual: ${currentTemperature}¬∞C` : 'Buscando temperatura...'}
                </p>
                {recommendedGoalByTemperature && (
                  <div className="flex items-center justify-between w-full p-3 rounded-xl bg-white/20">
                    <span className="text-sm">Meta Recomendada: <span className="font-bold">{recommendedGoalByTemperature} ml</span></span>
                    <button
                      onClick={() => onApplyRecommendedGoal(recommendedGoalByTemperature)}
                      className="p-1 rounded-full bg-white text-blue-500 hover:bg-gray-200 transition-colors"
                      aria-label="Aplicar meta recomendada"
                    >
                      <Save size={16} />
                    </button>
                  </div>
                )}
                <button
                  onClick={onFetchTemperature}
                  disabled={isLoadingTemperature}
                  className="flex items-center justify-center gap-2 p-3 rounded-xl bg-white/20 hover:bg-white/30 transition-colors w-full"
                  aria-label="Buscar temperatura e meta"
                >
                  <RefreshCcw size={20} className={isLoadingTemperature ? "animate-spin" : ""}/>
                  <span>{isLoadingTemperature ? 'Buscando...' : 'Atualizar Meta'}</span>
                </button>
              </div>
            </div>

            <div>
              <h3 className="text-lg font-bold mb-3">A√ß√µes Adicionais</h3>
              <button
                onClick={onResetWater}
                className="flex items-center justify-center gap-2 p-3 rounded-xl bg-white/20 hover:bg-white/30 transition-colors w-full"
                aria-label="Zerar Contador de √Ågua"
              >
                <RefreshCcw size={20} />
                <span>Zerar Contador de √Ågua</span>
              </button>
            </div>
          </div>
        </div>
      );
    };

    const ProgressChart = ({ currentWater, goalWater }) => {
      const chartRef = useRef(null);
      const chartInstanceRef = useRef(null);

      useEffect(() => {
        if (chartRef.current) {
          const ctx = chartRef.current.getContext('2d');
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
          }
          chartInstanceRef.current = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: ['Consumido', 'Restante'],
              datasets: [{
                data: [currentWater, Math.max(0, goalWater - currentWater)],
                backgroundColor: ['#ffffff', 'rgba(255, 255, 255, 0.1)'],
                borderWidth: 0,
                borderRadius: 20,
              }]
            },
            options: {
              responsive: true,
              cutout: '80%',
              plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
              }
            }
          });
        }
        return () => {
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
          }
        };
      }, [currentWater, goalWater]);

      return (
        <div className="relative w-64 h-64">
          <canvas ref={chartRef}></canvas>
          <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center text-white">
            <span className="text-5xl font-bold">{currentWater}</span>
            <span className="text-lg opacity-80">/ {goalWater} ml</span>
          </div>
        </div>
      );
    };

    const BottomNav = ({ currentPage, onNavigate, onOpenAddWater }) => {
      const commonButtonClasses = "p-3 rounded-full transition-colors";
      const getButtonClasses = (page) =>
        currentPage === page
          ? `${commonButtonClasses} bg-white/20 cursor-default`
          : `${commonButtonClasses} hover:bg-white/20`;

      return (
        <nav className="h-24 rounded-t-[30px] w-full mt-auto flex items-center justify-around text-white z-10">
          <button
            onClick={() => onNavigate('stats')}
            className={getButtonClasses('stats')}
            aria-label="Ver estat√≠sticas"
          >
            <BarChart3 size={28} />
          </button>

          <button onClick={onOpenAddWater} className="w-20 h-20 rounded-full bg-white text-blue-500 text-5xl font-light flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform duration-300" aria-label="Adicionar √°gua">+</button>

          <button
            onClick={() => onNavigate('settings')}
            className={getButtonClasses('settings')}
            aria-label="Abrir configura√ß√µes"
          >
            <Settings size={28} />
          </button>
        </nav>
      );
    };

    const AddWaterModal = ({ isOpen, onClose, onAddWater }) => {
      const [customAmount, setCustomAmount] = useState('');
      const inputRef = useRef(null);

      useEffect(() => {
        if (isOpen && inputRef.current) {
          inputRef.current.focus();
        }
      }, [isOpen]);

      if (!isOpen) return null;

      const handleConfirm = () => {
        const amount = parseInt(customAmount);
        if (amount > 0) {
          onAddWater(amount);
          setCustomAmount('');
        }
      };

      const handleShortcut = (amount) => {
        onAddWater(amount);
        setCustomAmount('');
      };

      return (
        <div className="fixed inset-0 w-full h-full bg-black/30 backdrop-blur-sm flex items-center justify-center z-20" onClick={onClose}>
          <div className="bg-white/10 backdrop-blur-xl border border-white/20 shadow-lg w-full max-w-xs rounded-3xl p-6 text-white flex flex-col items-center" onClick={(e) => e.stopPropagation()}>
            <h2 className="text-xl font-bold mb-6">Adicionar √Ågua</h2>

            <div className="grid grid-cols-3 gap-4 w-full mb-6">
              <button onClick={() => handleShortcut(150)} className="bg-white/10 border border-white/20 rounded-xl p-4 text-center hover:bg-white/30 transition-colors">150ml</button>
              <button onClick={() => handleShortcut(250)} className="bg-white/10 border border-white/20 rounded-xl p-4 text-center hover:bg-white/30 transition-colors">250ml</button>
              <button onClick={() => handleShortcut(500)} className="bg-white/10 border border-white/20 rounded-xl p-4 text-center hover:bg-white/30 transition-colors">500ml</button>
            </div>

            <div className="w-full mb-6">
              <input
                ref={inputRef}
                type="number"
                value={customAmount}
                onChange={(e) => setCustomAmount(e.target.value)}
                placeholder="Ou digite um valor (ml)"
                className="bg-white/10 border border-white/20 w-full rounded-xl px-4 py-3 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50"
              />
            </div>

            <div className="flex w-full gap-4">
              <button onClick={onClose} className="flex-1 bg-white/10 rounded-xl py-3 hover:bg-white/20 transition-colors">Cancelar</button>
              <button onClick={handleConfirm} className="flex-1 bg-white text-blue-500 rounded-xl py-3 font-bold hover:bg-gray-200 transition-colors">Adicionar</button>
            </div>
          </div>
        </div>
      );
    };

    const FeedbackModal = ({ isOpen, message, isError }) => {
      if (!isOpen) return null;
      return (
        <div className={`fixed bottom-8 left-1/2 -translate-x-1/2 z-30 p-4 rounded-xl shadow-lg transition-all duration-300 transform ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`}>
          <p>{message}</p>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    // Inicializa os √≠cones Lucide
    lucide.createIcons();
  </script>
</body>
</html>